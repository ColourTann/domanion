<!doctype html> 
<html lang="en"> 
<head> 
    <script src='card.js'></script>
    <script src='player.js'></script>
    <script src='tableau.js'></script>
    <script src='button.js'></script>
    <script src='infopanel.js'></script>
    <script src='stack.js'></script>
    <script src='prompt.js'></script>
    <script src='log.js'></script>
    <meta charset="UTF-8" />
    <title>domanion</title>
    <script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>


<script type="text/javascript">




var sock = new WebSocket("ws://localhost:7981/dominion"); //localhost:7981
sock.onopen= function(e){
   document.getElementById("formdiv").style.display="block";
};
sock.onmessage= function(m){
    console.log("from server: "+m.data);
    var string = m.data;
    var data = string.substring(1,m.data.length);
    if(m.data.charAt(0)=="s")startGame(); //start game//
    if(m.data.charAt(0)=="e"){setState(GameStates.playing_cards);} //opponent ended turn//
    if(m.data.charAt(0)=="m")log.addLine(data, true); //message to log//
    
}

var message ="";
var separator=">";
function sendMessage(string){
    if(string!="")message+=separator;
    message+=string;
}



var game = new Phaser.Game(1100, 650, Phaser.AUTO, 'gamm', { preload: preload, create: create, update: update });

var c_light = 0xdeeed6;
var c_green = 0x346524;
var c_copper = 0x854c30;
var c_silver = 0x8595a1;
var c_gold = 0xd27d2c;
var c_yellow = 0xdad45e;
var c_blueDark = 0x30346d;
var c_dark = 0x140c1c;
var c_greyDark= 0x4e4a4e;

function joingame(){
    document.getElementById("formdiv").style.display="none";
    username=document.getElementById("username").value;
    sendMessage("h"+document.getElementById("gamename").value);
    return false;
}


function preload() {
    game.load.bitmapFont('silkscreen', 'assets/silkscreen_0.png', 'assets/silkscreen.fnt');
    game.load.image('yv', 'assets/yv.png');
    game.load.image('cardBase', 'assets/cardbase.png');
    game.load.image('cardOutline', 'assets/cardoutline.png');
    game.load.image('cardback', 'assets/cardback.png');
    game.load.image('pixel', 'assets/pixel.png');
    game.load.image('cardpic', 'assets/image.png');
    game.load.image('button', 'assets/button.png');
    game.load.image('cost', 'assets/cost.png');
    game.load.image('bigbutton', 'assets/bigbutton.png');
    game.load.image('longbutton', 'assets/longbutton.png');
    game.load.image('invisiblecard', 'assets/invisiblecard.png');
}

var GameStates={
    playing_cards:0, trashCardFromHand:1, gainCardCosting:2, gainCardMax:3, discard:4,
    trashCopper:5, trashTreasure:6, gainTreasure:7, enemyturn:8
};

var username= "tann";
var log;

var player;
var gameState=GameStates.enemyturn;
var stateAction;
var stateAmount;
var stateArg;
var stateSpecial;
var postActions;
var playedCard;









function create() {
    game.stage.backgroundColor = c_greyDark;

}

function startGame(){
    infoPanel=new InfoPanel();
    setupCards();
    new Tableau();
    player = new Player();
    log = new Log();
}

function update() {
    if(message!=""){
        sock.send(message);
        message="";
    }
}

function setState(state, arg, optional, after){
    this.gameState=state;
    stateArg=arg;
    postActions=after;
    stateSpecial=[];
   console.log("setting state: "+stringEnum(state, GameStates));
    switch(gameState){
        case GameStates.playing_cards:
            removePrompt();
            player.showButtons(true);
        break;
        case GameStates.enemyturn:
            player.showButtons(false);
        break;
        case GameStates.trashCardFromHand:
            addPrompt("Trash "+arg+" card"+(arg==1?"":"s")+" from your hand", optional);
            this.stateAmount=arg;
        break;
        case GameStates.gainCardMax:
            addPrompt("Gain a card costing up to "+arg, optional);
        break;
        case GameStates.discard:
            stateSpecial=0;
            addPrompt("discard "+(arg==0?"":(arg==1?" ":"s "))+ "cards", arg==0);
            this.stateAmount=(arg==0?999:arg);
            console.log(this.stateAmount);
        break;
        case GameStates.trashCopper:
            this.stateAmount=1;
            addPrompt("trash a copper", false);
        break;
        case GameStates.trashTreasure:
            this.stateAmount=1;
            addPrompt("trash a treasure", false);
        break;

    }
}

function stateSuccess(all){
    if(!all&&stateAmount>1){
        stateAmount--;
        return;
    }
    console.log("success");
    if(postActions){
        postActions[0].run();     
    }
    else{
         setState(GameStates.playing_cards);
    }
}



</script>

<div style = "position: relative">

<div id = "gamm" style = "height: 650px; width: 1100px; position: absolute; left:0; top:0">

</div>
<div id = "formdiv" style = "display:none; height: 650px; width: 1100px; position: absolute; left:300px; top:200px">
<form onsubmit="return joingame()">
  username:<br>
  <input type="text" id="username" value="tann">
  <br>
  game name:<br>
  <input type="text" id="gamename" value="game">
  <br><br>
  <input type="submit" value="Submit">
</form>
</div>
</div>
</body>
</html>